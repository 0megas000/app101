<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bleeding Borderlands - Interactive Map Editor</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="styles-v2.css">
</head>
<body>
    <!-- Main App Container -->
    <div class="app-container">

        <!-- ==================== HEADER ==================== -->
        <header class="app-header">
            <div class="header-left">
                <button id="toggle-left-sidebar" class="sidebar-toggle-btn" title="Toggle Locations List (L)">
                    <span class="toggle-icon">‚ò∞</span>
                </button>
                <h1 class="app-title">‚öîÔ∏è BLEEDING BORDERLANDS ‚öîÔ∏è</h1>
            </div>

            <div class="header-center">
                <div class="save-status">
                    <span id="save-status-indicator" class="status-indicator"></span>
                    <span id="save-status-text">Initializing...</span>
                </div>
            </div>

            <div class="header-right">
                <button id="btn-help" class="header-btn" title="Help & Shortcuts (H)">
                    <span>‚ùì</span>
                </button>
                <button id="btn-export" class="header-btn" title="Export Data">
                    <span>üíæ</span>
                </button>
                <button id="btn-import" class="header-btn" title="Import Data">
                    <span>üì•</span>
                </button>
                <button id="toggle-right-sidebar" class="sidebar-toggle-btn" title="Toggle Legend (G)">
                    <span class="toggle-icon">‚ò∞</span>
                </button>
            </div>
        </header>

        <!-- ==================== LEFT SIDEBAR: LOCATIONS LIST ==================== -->
        <aside id="left-sidebar" class="sidebar sidebar-left">
            <div class="sidebar-header">
                <h2 class="sidebar-title">üìç Locations</h2>
                <button id="btn-add-location" class="btn btn-primary">
                    <span>‚ûï</span> Add Location
                </button>
            </div>

            <div class="sidebar-content">
                <!-- Search & Filter -->
                <div class="search-container">
                    <input
                        type="text"
                        id="location-search"
                        class="search-input"
                        placeholder="üîç Search locations..."
                        autocomplete="off"
                    >
                </div>

                <div class="filter-container">
                    <label class="filter-label">Filter by Type:</label>
                    <select id="location-filter" class="filter-select">
                        <option value="all">All Types</option>
                        <option value="city">Cities</option>
                        <option value="town">Towns</option>
                        <option value="village">Villages</option>
                        <option value="fortress">Fortresses</option>
                        <option value="ruins">Ruins</option>
                        <option value="landmark">Landmarks</option>
                        <option value="dungeon">Dungeons</option>
                        <option value="camp">Camps</option>
                    </select>
                </div>

                <!-- Location List -->
                <div id="location-list" class="location-list">
                    <!-- Dynamically populated by JavaScript -->
                    <div class="location-list-placeholder">
                        <p>Loading locations...</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="location-count">
                    <span id="location-count-text">0 locations</span>
                </div>
            </div>
        </aside>

        <!-- ==================== MAP CONTAINER ==================== -->
        <main class="map-main">
            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button id="btn-zoom-in" class="zoom-btn" title="Zoom In (+)">
                    <span>‚ûï</span>
                </button>
                <div id="zoom-level" class="zoom-level">100%</div>
                <button id="btn-zoom-out" class="zoom-btn" title="Zoom Out (-)">
                    <span>‚ûñ</span>
                </button>
                <button id="btn-zoom-reset" class="zoom-btn" title="Reset View (0)">
                    <span>üéØ</span>
                </button>
            </div>

            <!-- Map SVG Container -->
            <div id="map-svg-container" class="map-svg-container">
                <!-- SVG will be injected here by MapRenderer -->
            </div>

            <!-- Map Overlay Info -->
            <div class="map-overlay-info">
                <div id="coordinates-display" class="coordinates-display">
                    <span>X: <span id="coord-x">0</span> mi</span>
                    <span>Y: <span id="coord-y">0</span> mi</span>
                </div>
            </div>
        </main>

        <!-- ==================== RIGHT SIDEBAR: LEGEND & CONTROLS ==================== -->
        <aside id="right-sidebar" class="sidebar sidebar-right">
            <div class="sidebar-header">
                <h2 class="sidebar-title">üó∫Ô∏è Legend & Layers</h2>
            </div>

            <div class="sidebar-content">
                <!-- Layer Toggles -->
                <div class="control-section">
                    <h3 class="control-section-title">Map Layers</h3>

                    <label class="toggle-control">
                        <input type="checkbox" id="toggle-corruption" checked>
                        <span class="toggle-label">‚ö° Corruption Zones</span>
                        <span class="toggle-shortcut">C</span>
                    </label>

                    <label class="toggle-control">
                        <input type="checkbox" id="toggle-factions" checked>
                        <span class="toggle-label">üõ°Ô∏è Faction Territories</span>
                        <span class="toggle-shortcut">F</span>
                    </label>

                    <label class="toggle-control">
                        <input type="checkbox" id="toggle-routes" checked>
                        <span class="toggle-label">üõ§Ô∏è Trade Routes</span>
                        <span class="toggle-shortcut">R</span>
                    </label>

                    <label class="toggle-control">
                        <input type="checkbox" id="toggle-distance-rings">
                        <span class="toggle-label">üìè Distance Rings</span>
                        <span class="toggle-shortcut">D</span>
                    </label>

                    <label class="toggle-control">
                        <input type="checkbox" id="toggle-secrets">
                        <span class="toggle-label">üîí Secret Locations</span>
                        <span class="toggle-shortcut">S</span>
                    </label>

                    <label class="toggle-control">
                        <input type="checkbox" id="toggle-labels" checked>
                        <span class="toggle-label">üè∑Ô∏è Location Labels</span>
                        <span class="toggle-shortcut">B</span>
                    </label>
                </div>

                <!-- Edit Mode -->
                <div class="control-section">
                    <h3 class="control-section-title">Editor</h3>

                    <label class="toggle-control toggle-edit-mode">
                        <input type="checkbox" id="toggle-edit-mode">
                        <span class="toggle-label">‚úèÔ∏è Edit Mode</span>
                        <span class="toggle-shortcut">E</span>
                    </label>

                    <div class="edit-mode-help">
                        <small>Enable to drag locations and access editor</small>
                    </div>
                </div>

                <!-- Location Types Legend -->
                <div class="legend-section">
                    <h3 class="legend-title">Location Types</h3>

                    <div class="legend-item">
                        <div class="legend-symbol city"></div>
                        <span class="legend-text">üè∞ City</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-symbol town"></div>
                        <span class="legend-text">üèòÔ∏è Town</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-symbol village"></div>
                        <span class="legend-text">üè° Village</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-symbol fortress"></div>
                        <span class="legend-text">‚öîÔ∏è Fortress</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-symbol ruins"></div>
                        <span class="legend-text">üèõÔ∏è Ruins</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-symbol landmark"></div>
                        <span class="legend-text">‚õ∞Ô∏è Landmark</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-symbol dungeon"></div>
                        <span class="legend-text">‚ö†Ô∏è Dungeon</span>
                    </div>

                    <div class="legend-item">
                        <div class="legend-symbol camp"></div>
                        <span class="legend-text">‚õ∫ Camp</span>
                    </div>
                </div>

                <!-- Corruption Levels -->
                <div class="legend-section">
                    <h3 class="legend-title">Corruption Levels</h3>

                    <div class="legend-item">
                        <div class="corruption-swatch level-0"></div>
                        <span class="legend-text">Level 0: Safe</span>
                    </div>

                    <div class="legend-item">
                        <div class="corruption-swatch level-1"></div>
                        <span class="legend-text">Level 1: Flutter</span>
                    </div>

                    <div class="legend-item">
                        <div class="corruption-swatch level-2"></div>
                        <span class="legend-text">Level 2: Bleeding</span>
                    </div>

                    <div class="legend-item">
                        <div class="corruption-swatch level-3"></div>
                        <span class="legend-text">Level 3: Storm</span>
                    </div>

                    <div class="legend-item">
                        <div class="corruption-swatch level-4"></div>
                        <span class="legend-text">Level 4: Chaos</span>
                    </div>
                </div>

                <!-- Faction Colors -->
                <div class="legend-section">
                    <h3 class="legend-title">Factions</h3>

                    <div class="legend-item">
                        <div class="faction-swatch" style="background: #2E5C8A;"></div>
                        <span class="legend-text">Arcane Covenant</span>
                    </div>

                    <div class="legend-item">
                        <div class="faction-swatch" style="background: #D4AF37;"></div>
                        <span class="legend-text">Golden Legion</span>
                    </div>

                    <div class="legend-item">
                        <div class="faction-swatch" style="background: #6B6B6B;"></div>
                        <span class="legend-text">Iron Brotherhood</span>
                    </div>

                    <div class="legend-item">
                        <div class="faction-swatch" style="background: #228B22;"></div>
                        <span class="legend-text">Verdant Circle</span>
                    </div>

                    <div class="legend-item">
                        <div class="faction-swatch" style="background: #8B0000;"></div>
                        <span class="legend-text">Crimson Pact</span>
                    </div>

                    <div class="legend-item">
                        <div class="faction-swatch" style="background: #4B0082;"></div>
                        <span class="legend-text">Shadow Syndicate</span>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="control-section">
                    <h3 class="control-section-title">Data Management</h3>

                    <button id="btn-manual-save" class="btn btn-secondary btn-full">
                        üíæ Save Now
                    </button>

                    <button id="btn-undo" class="btn btn-secondary" disabled>
                        ‚Ü∂ Undo
                    </button>

                    <button id="btn-redo" class="btn btn-secondary" disabled>
                        ‚Ü∑ Redo
                    </button>

                    <div class="data-actions">
                        <button id="btn-export-json" class="btn btn-outline btn-full">
                            üì§ Export JSON
                        </button>

                        <button id="btn-import-json" class="btn btn-outline btn-full">
                            üì• Import JSON
                        </button>

                        <button id="btn-reset-data" class="btn btn-danger btn-full">
                            üîÑ Reset to Defaults
                        </button>
                    </div>
                </div>

                <!-- Storage Info -->
                <div class="storage-info">
                    <div class="storage-bar">
                        <div id="storage-bar-fill" class="storage-bar-fill" style="width: 0%"></div>
                    </div>
                    <div class="storage-text">
                        <small>Storage: <span id="storage-used">0</span> KB / 5 MB</small>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ==================== FOOTER ==================== -->
        <footer class="app-footer">
            <div class="footer-left">
                <span class="footer-text">
                    "The Maelstrom grows. Reality tears. Six factions race against time."
                </span>
            </div>

            <div class="footer-center">
                <span class="footer-text">
                    Scale: 10 pixels = 1 mile | Canvas: 2400√ó2400px (240√ó240 miles)
                </span>
            </div>

            <div class="footer-right">
                <span class="footer-text">
                    Auto-save: <span id="auto-save-status">Active</span> |
                    Last saved: <span id="last-save-time">Never</span>
                </span>
            </div>
        </footer>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Location Editor Modal -->
    <div id="location-editor-modal" class="modal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 id="editor-modal-title">Add New Location</h2>
                <button id="editor-close-btn" class="modal-close-btn">&times;</button>
            </div>

            <form id="location-editor-form" class="modal-body">
                <!-- Basic Info -->
                <div class="form-section">
                    <h3 class="form-section-title">Basic Information</h3>

                    <div class="form-row">
                        <label class="form-label required">
                            Name
                            <input
                                type="text"
                                id="edit-name"
                                name="name"
                                class="form-input"
                                required
                                placeholder="Enter location name"
                            >
                        </label>
                    </div>

                    <div class="form-row form-row-2">
                        <label class="form-label required">
                            Type
                            <select id="edit-type" name="type" class="form-select" required>
                                <option value="city">City</option>
                                <option value="town">Town</option>
                                <option value="village">Village</option>
                                <option value="fortress">Fortress</option>
                                <option value="ruins">Ruins</option>
                                <option value="landmark">Landmark</option>
                                <option value="dungeon">Dungeon</option>
                                <option value="camp">Camp</option>
                            </select>
                        </label>

                        <label class="form-label">
                            Population
                            <input
                                type="number"
                                id="edit-population"
                                name="population"
                                class="form-input"
                                min="0"
                                placeholder="0"
                            >
                        </label>
                    </div>
                </div>

                <!-- Position -->
                <div class="form-section">
                    <h3 class="form-section-title">Position</h3>

                    <div class="form-row form-row-2">
                        <label class="form-label required">
                            X (miles from Maelstrom)
                            <input
                                type="number"
                                id="edit-x"
                                name="x"
                                class="form-input"
                                required
                                step="0.1"
                                min="-120"
                                max="120"
                            >
                        </label>

                        <label class="form-label required">
                            Y (miles from Maelstrom)
                            <input
                                type="number"
                                id="edit-y"
                                name="y"
                                class="form-input"
                                required
                                step="0.1"
                                min="-120"
                                max="120"
                            >
                        </label>
                    </div>

                    <div class="form-help">
                        <small>Maelstrom is at (0, 0). Drag location on map or enter coordinates manually.</small>
                    </div>
                </div>

                <!-- Details -->
                <div class="form-section">
                    <h3 class="form-section-title">Details</h3>

                    <div class="form-row">
                        <label class="form-label">
                            Description
                            <textarea
                                id="edit-description"
                                name="description"
                                class="form-textarea"
                                rows="4"
                                placeholder="Describe this location..."
                            ></textarea>
                        </label>
                    </div>

                    <div class="form-row form-row-2">
                        <label class="form-label">
                            Faction
                            <select id="edit-faction" name="faction" class="form-select">
                                <option value="">None</option>
                                <option value="arcane-covenant">Arcane Covenant</option>
                                <option value="golden-legion">Golden Legion</option>
                                <option value="iron-brotherhood">Iron Brotherhood</option>
                                <option value="verdant-circle">Verdant Circle</option>
                                <option value="crimson-pact">Crimson Pact</option>
                                <option value="shadow-syndicate">Shadow Syndicate</option>
                            </select>
                        </label>

                        <label class="form-label">
                            Corruption Level
                            <select id="edit-corruption" name="corruption" class="form-select">
                                <option value="0">0 - Safe</option>
                                <option value="1">1 - Flutter</option>
                                <option value="2">2 - Bleeding</option>
                                <option value="3">3 - Storm</option>
                                <option value="4">4 - Chaos</option>
                            </select>
                        </label>
                    </div>
                </div>

                <!-- Properties -->
                <div class="form-section">
                    <h3 class="form-section-title">Properties</h3>

                    <div class="form-row form-checkboxes">
                        <label class="form-checkbox">
                            <input type="checkbox" id="edit-secret" name="secret">
                            <span>üîí Secret Location (hidden by default)</span>
                        </label>

                        <label class="form-checkbox">
                            <input type="checkbox" id="edit-important" name="important">
                            <span>‚≠ê Important Location</span>
                        </label>

                        <label class="form-checkbox">
                            <input type="checkbox" id="edit-discovered" name="discovered" checked>
                            <span>üëÅÔ∏è Discovered by Party</span>
                        </label>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-section">
                    <h3 class="form-section-title">GM Notes</h3>

                    <div class="form-row">
                        <label class="form-label">
                            Private Notes
                            <textarea
                                id="edit-notes"
                                name="notes"
                                class="form-textarea"
                                rows="3"
                                placeholder="Private notes (not shown to players)..."
                            ></textarea>
                        </label>
                    </div>
                </div>

                <!-- Validation Errors -->
                <div id="form-errors" class="form-errors" style="display: none;"></div>

                <!-- Form Actions -->
                <div class="modal-footer">
                    <button type="button" id="editor-cancel-btn" class="btn btn-outline">
                        Cancel
                    </button>
                    <button type="button" id="editor-delete-btn" class="btn btn-danger" style="display: none;">
                        Delete Location
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="editor-submit-text">Add Location</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal" style="display: none;">
        <div class="modal-dialog modal-dialog-large">
            <div class="modal-header">
                <h2>‚ùì Help & Keyboard Shortcuts</h2>
                <button id="help-close-btn" class="modal-close-btn">&times;</button>
            </div>

            <div class="modal-body">
                <div class="help-section">
                    <h3>üéÆ Map Navigation</h3>
                    <ul class="help-list">
                        <li><strong>Mouse Wheel:</strong> Zoom in/out (cursor-centered)</li>
                        <li><strong>Click + Drag:</strong> Pan around the map</li>
                        <li><strong>Touch:</strong> Pinch to zoom, drag to pan</li>
                        <li><strong>Click Location:</strong> Select and view details</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                    <div class="shortcuts-grid">
                        <div class="shortcut-item">
                            <kbd>C</kbd>
                            <span>Toggle Corruption Zones</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>F</kbd>
                            <span>Toggle Faction Territories</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>R</kbd>
                            <span>Toggle Trade Routes</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>D</kbd>
                            <span>Toggle Distance Rings</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>S</kbd>
                            <span>Toggle Secret Locations</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>B</kbd>
                            <span>Toggle Labels</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>E</kbd>
                            <span>Toggle Edit Mode</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>L</kbd>
                            <span>Toggle Locations Sidebar</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>G</kbd>
                            <span>Toggle Legend Sidebar</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>H</kbd>
                            <span>Show Help</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>+</kbd> / <kbd>=</kbd>
                            <span>Zoom In</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>-</kbd>
                            <span>Zoom Out</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>0</kbd>
                            <span>Reset View</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd>+<kbd>S</kbd>
                            <span>Manual Save</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd>+<kbd>Z</kbd>
                            <span>Undo</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd>+<kbd>Y</kbd>
                            <span>Redo</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Esc</kbd>
                            <span>Close Modal/Deselect</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>N</kbd>
                            <span>New Location</span>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3>‚úèÔ∏è Edit Mode</h3>
                    <ul class="help-list">
                        <li>Enable Edit Mode to drag locations and reposition them</li>
                        <li>Click a location to edit its properties</li>
                        <li>Use "Add Location" button to create new locations</li>
                        <li>All changes are auto-saved every 30 seconds</li>
                        <li>Undo/Redo available for last 10 actions</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üíæ Data Management</h3>
                    <ul class="help-list">
                        <li><strong>Auto-save:</strong> Changes saved automatically every 30 seconds</li>
                        <li><strong>LocalStorage:</strong> Data persists in browser (up to 5 MB)</li>
                        <li><strong>Backups:</strong> Last 3 saves backed up automatically</li>
                        <li><strong>Export:</strong> Download map data as JSON file</li>
                        <li><strong>Import:</strong> Load map data from JSON file</li>
                        <li><strong>Reset:</strong> Restore to default campaign data</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üó∫Ô∏è Map Features</h3>
                    <ul class="help-list">
                        <li><strong>Ocean:</strong> Cerulean Sea to the west with depth gradients</li>
                        <li><strong>Coastline:</strong> 95-mile Sapphire Coast with bays and cliffs</li>
                        <li><strong>Delta:</strong> Silverflow Delta where river meets ocean</li>
                        <li><strong>Rivers:</strong> Silverflow River flowing east to west</li>
                        <li><strong>Terrain:</strong> Elevation-based coloring (0-9,200 ft)</li>
                        <li><strong>Corruption:</strong> Maelstrom influence zones with 5 levels</li>
                        <li><strong>Factions:</strong> 6 faction territories with color coding</li>
                        <li><strong>Routes:</strong> Trade routes connecting major settlements</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üìê Scale & Coordinates</h3>
                    <ul class="help-list">
                        <li><strong>Scale:</strong> 10 pixels = 1 mile</li>
                        <li><strong>Canvas:</strong> 2400√ó2400 pixels (240√ó240 miles)</li>
                        <li><strong>Center:</strong> The Maelstrom at (0, 0)</li>
                        <li><strong>Coordinates:</strong> Real-world miles from Maelstrom center</li>
                        <li><strong>Bounds:</strong> -120 to +120 miles in all directions</li>
                    </ul>
                </div>
            </div>

            <div class="modal-footer">
                <button id="help-close-btn-2" class="btn btn-primary">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2>üì• Import Map Data</h2>
                <button id="import-close-btn" class="modal-close-btn">&times;</button>
            </div>

            <div class="modal-body">
                <div class="import-section">
                    <p>Select a JSON file to import map data. This will replace all current data.</p>
                    <p class="warning-text">‚ö†Ô∏è Current data will be backed up before import.</p>

                    <div class="file-upload">
                        <input
                            type="file"
                            id="import-file-input"
                            accept=".json,application/json"
                            style="display: none;"
                        >
                        <button id="import-select-file-btn" class="btn btn-outline btn-full">
                            üìÅ Select JSON File
                        </button>
                    </div>

                    <div id="import-file-info" class="file-info" style="display: none;">
                        <p>Selected: <strong id="import-filename"></strong></p>
                        <p>Size: <span id="import-filesize"></span></p>
                    </div>

                    <div id="import-error" class="form-errors" style="display: none;"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="import-cancel-btn" class="btn btn-outline">Cancel</button>
                <button id="import-confirm-btn" class="btn btn-primary" disabled>
                    Import Data
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification-toast" class="notification-toast" style="display: none;">
        <div class="notification-content">
            <span id="notification-icon" class="notification-icon"></span>
            <span id="notification-message" class="notification-message"></span>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="hidden-file-input" accept=".json" style="display: none;">

    <!-- ==================== SCRIPTS ==================== -->

    <!-- Core Data -->
    <script src="map-data.js"></script>

    <!-- Core Systems -->
    <script src="pan-zoom.js"></script>
    <script src="data-manager.js"></script>
    <script src="map-renderer.js"></script>
    <script src="location-editor.js"></script>
    <script src="ui-controls.js"></script>

    <!-- Application Initialization -->
    <script>
        // ==================== APPLICATION INITIALIZATION ====================

        console.log('%cüó∫Ô∏è BLEEDING BORDERLANDS INTERACTIVE MAP', 'font-size: 20px; font-weight: bold; color: #D4AF37; text-shadow: 2px 2px 4px #000;');
        console.log('%cInitializing systems...', 'color: #8B6F47; font-weight: bold;');

        // Global application state
        const BleedingBorderlandsApp = {
            config: null,
            dataManager: null,
            mapRenderer: null,
            panZoom: null,
            locationEditor: null,
            uiControls: null,
            svgElement: null,

            // Initialize the entire application
            initialize() {
                console.log('üì¶ Loading configuration...');
                this.config = MAP_CONFIG;

                console.log('üíæ Initializing data manager...');
                this.dataManager = new DataManager({
                    version: "1.0",
                    lastModified: new Date().toISOString(),
                    locations: LOCATIONS,
                    features: GEOGRAPHIC_FEATURES,
                    routes: TRADE_ROUTES,
                    factions: FACTIONS,
                    corruption: CORRUPTION_ZONES,
                    ocean: OCEAN,
                    coastline: COASTLINE
                });

                console.log('üé® Initializing map renderer...');
                this.mapRenderer = new MapRenderer(
                    this.config,
                    this.dataManager.data.ocean,
                    this.dataManager.data.coastline,
                    this.dataManager.data.locations,
                    this.dataManager.data.features,
                    this.dataManager.data.routes,
                    this.dataManager.data.factions,
                    this.dataManager.data.corruption
                );

                const container = document.getElementById('map-svg-container');
                this.svgElement = this.mapRenderer.initialize(container);

                console.log('üñ±Ô∏è Initializing pan-zoom controller...');
                this.panZoom = new PanZoomController(this.svgElement, this.config);

                console.log('‚úèÔ∏è Initializing location editor...');
                this.locationEditor = new LocationEditor(
                    this.dataManager,
                    this.mapRenderer,
                    this.panZoom
                );
                this.locationEditor.initialize();

                console.log('üéõÔ∏è Initializing UI controls...');
                this.uiControls = new UIControls(
                    this.mapRenderer,
                    this.panZoom,
                    this.dataManager,
                    this.locationEditor
                );
                this.uiControls.initialize();

                // Setup event listeners
                this.setupEventListeners();

                // Setup modal close buttons
                this.setupModalHandlers();

                // Initial render
                console.log('üñºÔ∏è Rendering map...');
                this.mapRenderer.render();

                console.log('%c‚úì Application initialized successfully!', 'color: #228B22; font-weight: bold; font-size: 14px;');
                this.printDebugInfo();
            },

            // Setup modal handlers
            setupModalHandlers() {
                // Help modal close buttons
                const helpCloseBtn = document.getElementById('help-close-btn');
                const helpCloseBtn2 = document.getElementById('help-close-btn-2');
                const helpModal = document.getElementById('help-modal');

                if (helpCloseBtn && helpModal) {
                    helpCloseBtn.addEventListener('click', () => {
                        helpModal.style.display = 'none';
                        helpModal.classList.add('hidden');
                    });
                }

                if (helpCloseBtn2 && helpModal) {
                    helpCloseBtn2.addEventListener('click', () => {
                        helpModal.style.display = 'none';
                        helpModal.classList.add('hidden');
                    });
                }

                // Import modal close buttons
                const importCloseBtn = document.getElementById('import-close-btn');
                const importCancelBtn = document.getElementById('import-cancel-btn');
                const importModal = document.getElementById('import-modal');

                if (importCloseBtn && importModal) {
                    importCloseBtn.addEventListener('click', () => {
                        importModal.style.display = 'none';
                        importModal.classList.add('hidden');
                    });
                }

                if (importCancelBtn && importModal) {
                    importCancelBtn.addEventListener('click', () => {
                        importModal.style.display = 'none';
                        importModal.classList.add('hidden');
                    });
                }

                // Help button in header
                const btnHelp = document.getElementById('btn-help');
                if (btnHelp && helpModal) {
                    btnHelp.addEventListener('click', () => {
                        helpModal.style.display = 'flex';
                        helpModal.classList.remove('hidden');
                    });
                }

                // Import button in header
                const btnImport = document.getElementById('btn-import');
                if (btnImport && importModal) {
                    btnImport.addEventListener('click', () => {
                        importModal.style.display = 'flex';
                        importModal.classList.remove('hidden');
                    });
                }

                // Close modals on outside click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                            modal.classList.add('hidden');
                        }
                    });
                });

                // Close modals on ESC key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal').forEach(modal => {
                            modal.style.display = 'none';
                            modal.classList.add('hidden');
                        });
                    }
                });
            },

            // Setup global event listeners
            setupEventListeners() {
                // Listen for data changes to update UI
                document.addEventListener('locationchange', (e) => {
                    this.uiControls.updateLocationList();
                });

                document.addEventListener('datasave', (e) => {
                    if (e.detail.success) {
                        this.uiControls.showNotification('üíæ Map data saved', 'success');
                    } else {
                        this.uiControls.showNotification('‚ùå Save failed: ' + e.detail.error, 'error');
                    }
                });

                document.addEventListener('dataimport', (e) => {
                    if (e.detail.success) {
                        this.mapRenderer.render();
                        this.uiControls.updateLocationList();
                        this.uiControls.showNotification('‚úì Data imported successfully', 'success');
                    }
                });

                document.addEventListener('datareset', () => {
                    this.mapRenderer.render();
                    this.uiControls.updateLocationList();
                    this.uiControls.showNotification('üîÑ Data reset to defaults', 'info');
                });

                // Window unload warning if unsaved changes
                window.addEventListener('beforeunload', (e) => {
                    if (this.dataManager.isDirty) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            },

            // Print debug information
            printDebugInfo() {
                console.log('%cüìä Debug Information', 'color: #8B6F47; font-weight: bold; font-size: 14px;');
                console.log('Location count:', Object.keys(this.dataManager.data.locations).length);
                console.log('Canvas size:', `${this.config.canvasWidth}√ó${this.config.canvasHeight}px`);
                console.log('Map area:', `${this.config.totalAreaMiles}√ó${this.config.totalAreaMiles} miles`);
                console.log('Scale:', `${this.config.pixelsPerMile} pixels per mile`);
                console.log('\n%cüéÆ Global Access', 'color: #8B6F47; font-weight: bold;');
                console.log('App:', 'window.BleedingBorderlandsApp');
                console.log('Data Manager:', 'window.BleedingBorderlandsApp.dataManager');
                console.log('Map Renderer:', 'window.BleedingBorderlandsApp.mapRenderer');
                console.log('Pan-Zoom:', 'window.BleedingBorderlandsApp.panZoom');
                console.log('Location Editor:', 'window.BleedingBorderlandsApp.locationEditor');
                console.log('UI Controls:', 'window.BleedingBorderlandsApp.uiControls');
                console.log('\n%c‚å®Ô∏è Press H for keyboard shortcuts', 'color: #D4AF37; font-weight: bold;');
            }
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            BleedingBorderlandsApp.initialize();

            // Make globally accessible for debugging
            window.BleedingBorderlandsApp = BleedingBorderlandsApp;
        });

        // Handle page visibility change (pause auto-save when tab hidden)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('‚è∏Ô∏è Tab hidden - pausing auto-save');
                if (BleedingBorderlandsApp.dataManager) {
                    BleedingBorderlandsApp.dataManager.stopAutoSave();
                }
            } else {
                console.log('‚ñ∂Ô∏è Tab visible - resuming auto-save');
                if (BleedingBorderlandsApp.dataManager) {
                    BleedingBorderlandsApp.dataManager.startAutoSave();
                }
            }
        });
    </script>
</body>
</html>
